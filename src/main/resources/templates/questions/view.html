<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<title th:text="${'QnA - ' + shortedTitle}"></title>
</head>
<body>

	<div th:replace="questions/header :: header"></div>

	<h1 th:text="${question.title}"></h1>

	<p th:text="${question.detail}"></p>
	
	<p>
		<span id="q_upvotes" th:text="${question.upVotes}"></span>
		&nbsp;upvotes and 
		<span id="q_downvotes" th:text="${question.downVotes}"></span>
		&nbsp;downvotes.
	</p>

	<button id="q_upvote" type="button">upvote !</button>
	<button id="q_downvote" type="button">downvote !</button>

	<p id="q_tags">
		<span class="tag" th:text="${t.name}" th:each="t : ${question.tags}"></span>
	</p>

	<input type="text" list="allTags" id="addTagInput" placeholder="Add Tag">
	<button type="button" id="addTagButton">Add Tag</button>

	<datalist id="allTags">
		<option th:each="t : ${allTags}" th:value="${t.name}">
	</datalist>

	<div id="answers">

		<textarea id="yourAnswer" placeholder="Enter your answer here ..."></textarea>

		<div class="answer" th:each="a : ${question.answers}" th:text="${a.content}"></div>		

	</div>

	<script th:inline="javascript">

		document.addEventListener('DOMContentLoaded', (e)=>{
			document.getElementById('q_upvote').addEventListener('click', (evt)=>{
				let url = [[@{/questions/upvote/{qid}(qid=${question.id})}]];
				fetch(url, {method: 'PUT'}).then((res)=>{
					return res.text();
				}).then((data)=>{
					console.log(data);
					if(data == "true") {
						let upvotesSpan = document.getElementById('q_upvotes');
						let upvotes = Number(upvotesSpan.textContent);
						upvotesSpan.textContent = (upvotes + 1);
					}
				});
			});

			document.getElementById('q_downvote').addEventListener('click', (evt)=>{
				let url = [[@{/questions/downvote/{qid}(qid=${question.id})}]];
				fetch(url, {method: 'PUT'}).then((res)=>{
					return res.text();
				}).then((data)=>{
					if(data == "true") {
						let downvotesSpan = document.getElementById('q_downvotes');
						let downvotes = Number(downvotesSpan.textContent);
						downvotesSpan.textContent = (downvotes + 1);
					}
				});
			});


			document.getElementById('addTagButton').addEventListener('click', (evt)=>{
				let addTagInput = document.getElementById('addTagInput');
				let tag = addTagInput.value;
				let url = [[@{/questions/{qid}/addTag(qid=${question.id})}]];
				let q_tags = document.getElementById('q_tags');
				let datalist = document.getElementById('allTags');
				if(tag) {
					fetch(url, {method:'PUT',body:tag}).then((res)=>{
						return res.text();
					}).then((data)=>{
						if(data == 'true') {
							q_tags.innerHTML += '<span class="tag">'+tag+'</span>&nbsp;';
							allTags.innerHTML += '<option value="'+tag+'">';
							addTagInput.value = '';
						}
					});
				}
			});
		});

	</script>

	<style>
		.tag {margin-right: 7px;}
	</style>
</body>
</html>